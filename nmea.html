<h1>GPS</h1>

<h2>Source</h2>

<form>
    <label>Baud Rate:</label>
    <select id="baudrate">
        <option value="9600">9600</option>
        <option value="115200" selected>115200</option>
    </select>
    <button type="button" id="btnOpen"  onclick="btnOpenClick()"  >Open</button>
    <button type="button" id="btnClose" onclick="btnCloseClick()" >Close</button>
</form>

<form>
    <input type="file" id="lstFile" multiple />
    <button type="button" id="btnLoad" onclick="btnLoadClick()">Load</button>
</form>

<h2>Navigation</h2>
<form>
    <label>Date</label>
    <input type="text" id="txtDate"/><br />
    <label>Time</label>
    <input type="text" id="txtTime"/><br />
    <label>Latitude</label>
    <input type="text" id="txtLatitude"/><br />
    <label>Longitude</label>
    <input type="text" id="txtLongitude"/><br />
    <label>Altitude</label>
    <input type="number" id="txtAltitude"/><br />
    <label>Geoid</label>
    <input type="number" id="txtGeoid"/><br />
    <label>Speed[Knot]</label>
    <input type="number" id="txtKnot"/><br />
    <label>Speed[km/h]</label>
    <input type="number" id="txtKmh"/><br />
    <label>Direction</label>
    <input type="number" id="txtDirection"/><br />
    <label>Degree</label>
    <input type="number" id="txtDegree"/><br />
    <label>Diff</label>
    <input type="number" id="txtDiff"/><br />
    <label>Fix Mode</label>
    <input type="string" id="txtFixMode"/><br />
    <label>2G/3D</label>
    <input type="string" id="txt2D3D"/><br />
    <label>Age</label>
    <input type="number" id="txtAge"/><br />
    <label>HDOP</label>
    <input type="number" id="txtHDOP"/><br />
    <label>VDOP</label>
    <input type="number" id="txtVDOP"/><br />
    <label>PDOP</label>
    <input type="number" id="txtPDOP"/><br />
    <label>Used Satellites</label>
    <input type="string" id="txtSatellites"/><br />
</form>

<h2>Satellites</h2>

<form>
    <label>Satellite Views</label>
    <input type="number" id="txtViews"/><br />
</form>


<script>

var port;

var gsas = { GN:{}, GP:{}, GL:{}, GA:{}, GB:{}, GQ:{}, BD:{} }
var gsvs = { GN:{}, GP:{}, GL:{}, GA:{}, GB:{}, GQ:{}, BD:{} }

navigator.serial.addEventListener("connect", (e) => {
    console.log("Connected! target=" + e.target)
    document.getElementById("btnOpen").disabled = false;
    document.getElementById("btnClose").disabled = false;
});

navigator.serial.addEventListener("disconnect", (e) => {
    console.log("Disconnected! target="+ e.target)
    document.getElementById("btnOpen").disabled = true;
    document.getElementById("btnClose").disabled = true;

    port = null
});

async function btnOpenClick() {
    port = await navigator.serial.requestPort()
    const baudrate = document.getElementById("baudrate").value;
    await port.open({ baudRate: baudrate })
    console.log("Opend!")

    readLoop()
}

async function btnCloseClick() {
    await port.close()
    console.log("Closed!")
}

async function btnLoadClick() {
    const file = document.getElementById("lstFile").files[0];
    console.log("Load! file=" + file.name)

    const reader = new FileReader();
    reader.onload = () => {
        reader.result.split('\n').forEach(s => {
            if (s.startsWith('$')) {
                onMessage(s)
            }
        });        
    };
    reader.onerror = (err) =>  {
        console.error(err)
    };
    reader.readAsText(file);
}

async function readLoop() {
    buffer = new Uint8Array(0)
    const reader = port.readable.getReader();
    while (true) {
        const { value, done } = await reader.read();
        if (done) {
            reader.releaseLock();
            break;
        }

        buffer = concatTypedArrays(buffer, value)
        if (buffer.at(-1) == 10) {
            const s = new TextDecoder().decode(buffer)
            buffer = new Uint8Array(0)
            if (s.startsWith('$')) {
                onMessage(s)
            }
        }
    }
}

function onMessage(message) {
    const items = message.split(',')
    const type  = items[0].substring(3, 6)

    switch(type) {
        case 'GGA':
            //console.log(message);
            onGGA(items)
            break
        case 'GGL':
            break;
        case 'GSA':
            //console.log(message);
            onGSA(items);
            break
        case 'GSV':
            //console.log(message);
            onGSV(items);
            break
        case 'RMC':
            //console.log(message);
            onRMC(items)
            break
        case 'VTG':
            console.log(message);
            onVTG(items)
            break
        default:
            //console.log(type)
            break
    }
}

function to_time(item) {
    return `${item.substring(0, 2)}:${item.substring(2, 4)}:${item.substring(4)}`
}

function to_date(item) {
    return `20${item.substring(4)}-${item.substring(2, 4)}-${item.substring(0, 2)}`
}

function to_degree(item1, item2) {
    var degree
    if (item1[4] == '.') 
        degree = Number(item1.substring(0, 2)) + Number(item1.substring(2))/60
    else
        degree = Number(item1.substring(0, 3)) + Number(item1.substring(3))/60

    if (item2 == 'S' || item2 == 'W') {
        degree  *= -1
    }
    
    return degree
}

function to_altitude(item1, item2) {
    var alt = Number(item1)
    return alt
}

function to_diff(item1, item2) {
    var diff = Number(item1)

    if (item2 == 'S' || item2 == 'W') {
        diff  *= -1
    }
    
    return diff
}

function onGSV(items) {
    const tracker = items[0].substring(1, 3)
    const sentenses = Number(items[1])
    const sentenseNo = Number(items[2])
    const views = Number(items[3].split('*')[0])
    document.getElementById("txtViews").value = views

    const slen = (items.length - 4)/4
    for (var i=0; i<slen; i++) {
        const offset = 4 + 4*i
        const id = tracker + items[offset]
        const gyokaku = Number(items[offset + 1])
        const houikaku = Number(items[offset + 2])
        const cnr = Number(items[offset + 3].split('*')[0])
        gsvs[tracker][id] = { gyokaku: gyokaku, houikaku: houikaku, cnr: cnr}
    }
}

function onGSA(items) {
    const tracker = items[0].substring(1, 3)
    const mode = items[1]
    document.getElementById("txt2D3D").value = items[2]

    const offset = 3
    for(var i=0; i<12; i++) {
        const id = tracker + items[offset + i]
        gsas[tracker][id] = { use: true }
    }

    document.getElementById("txtPDOP").value = Number(items[3 + 12])
    document.getElementById("txtHDOP").value = Number(items[3 + 12 + 1])
    document.getElementById("txtVDOP").value = Number(items[3 + 12 + 2].split('*')[0])
}

function onGGA(items) {
    const status = items[6]
    if (status != '0') {
        document.getElementById("txtTime").value = to_time(items[1])
        document.getElementById("txtLatitude").value  = to_degree(items[2], items[3])
        document.getElementById("txtLongitude").value = to_degree(items[4], items[5])
        document.getElementById("txtSatellites").value = items[7]
        document.getElementById("txtHDOP").value = Number(items[8])
        document.getElementById("txtAltitude").value = to_altitude(items[9], items[10])
        document.getElementById("txtGeoid").value = to_altitude(items[11], items[12])
        document.getElementById("txtAge").value = Number(items[13])
    }
}

function onRMC(items) {
    const status = items[2]
    document.getElementById("txtTime").value = to_time(items[1])
    document.getElementById("txtDate").value = to_date(items[9])

    if (status == 'A') {
        document.getElementById("txtLatitude").value  = to_degree(items[3], items[4])
        document.getElementById("txtLongitude").value = to_degree(items[5], items[6])
        document.getElementById("txtKnot").value = Number(items[7])
        document.getElementById("txtDirection").value = Number(items[8])
        document.getElementById("txtDegree").value = Number(items[10])
        document.getElementById("txtDiff").value = to_diff(items[11], items[12])
        document.getElementById("txtFixMode").value = items[12].split('*')[0]
    }
}

function onVTG(items) {
    const tracker = items[0].substring(1, 3)
    const mode = items[9].split('*')[0]
    if (mode != 'M') {
        const trueNorth = Number(items[1])
        const magNorth = Number(items[3])
        document.getElementById("txtKnot").value = Number(items[5])
        document.getElementById("txtKmh").value = Number(items[7])
    }
}

function concatTypedArrays(a, b) { // a, b TypedArray of same type
    var c = new (a.constructor)(a.length + b.length);
    c.set(a, 0);
    c.set(b, a.length);
    return c;
}

</script>